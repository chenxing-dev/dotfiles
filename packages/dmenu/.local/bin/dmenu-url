#!/usr/bin/env bash
# Dedicated URL launcher with bookmark support

backend="auto"
while [[ $# -gt 0 ]]; do
	case "$1" in
	--backend)
		backend="${2:-}"
		shift 2
		;;
	-h | --help)
		echo "Usage: dmenu-url [--backend rofi|fuzzel]" >&2
		exit 0
		;;
	*)
		echo "Unknown arg: $1" >&2
		exit 2
		;;
	esac
done

script_dir="$(CDPATH= cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
source "$script_dir/dmenu-backend.sh"
use_dmenu_backend "$backend"

# Configuration
BOOKMARKS_FILE="$HOME/.config/bookmarks.json"
EDITOR="code"
STARTPAGE_URL="chenxing.dev"

validate_bookmarks() {
	mkdir -p "$(dirname "$BOOKMARKS_FILE")"
	if [[ ! -f "$BOOKMARKS_FILE" ]]; then
		printf '%s\n' '[]' >"$BOOKMARKS_FILE"
		return
	fi

	# If file is empty/whitespace, initialize it.
	if [[ ! -s "$BOOKMARKS_FILE" ]] || [[ -z "$(tr -d '[:space:]' <"$BOOKMARKS_FILE")" ]]; then
		printf '%s\n' '[]' >"$BOOKMARKS_FILE"
		return
	fi

	# If invalid JSON, do not clobber; let user fix it.
	if command -v jq >/dev/null 2>&1; then
		if ! jq -e 'type == "array"' "$BOOKMARKS_FILE" >/dev/null 2>&1; then
			notify-send "demnu-url" "Invalid bookmarks JSON: $BOOKMARKS_FILE" -t 3000
		fi
	fi
}

trim() {
	local s="$1"
	# trim leading whitespace
	s="${s#"${s%%[![:space:]]*}"}"
	# trim trailing whitespace
	s="${s%"${s##*[![:space:]]}"}"
	printf '%s' "$s"
}

# Load bookmarks JSON (array) into a variable
load_bookmarks_json() {
	if ! command -v jq >/dev/null 2>&1; then
		notify-send "dmenu-url" "jq is required to read JSON bookmarks" -t 2500
		return 1
	fi

	BOOKMARKS_JSON=$(jq -c '.' "$BOOKMARKS_FILE")
}

build_menu_from_json() {
	local json_array="$1"
	local in_submenu="$2" # "1" if stack not empty

	MENU_LABELS=()
	MENU_TYPES=()   # action|entry
	MENU_INDEXES=() # index in json array for entry

	# Root-only actions
	if [[ "$in_submenu" != "1" ]]; then
		MENU_LABELS+=("üÜï New Tab")
		MENU_TYPES+=("action")
		MENU_INDEXES+=(-1)
	fi

	local sep=$'\x1f'
	while IFS= read -r row; do
		[[ -z "$row" ]] && continue
		local idx="${row%%$sep*}"
		local label="${row#*$sep}"
		MENU_LABELS+=("$label")
		MENU_TYPES+=("entry")
		MENU_INDEXES+=("$idx")
	done < <(
		jq -r 'to_entries[] | ("\(.key)\u001f\((.value.icon // "üìÑ") + " " + (.value.name // .value.href // "Unnamed"))")' <<<"$json_array"
	)

	# Root-only actions
	if [[ "$in_submenu" != "1" ]]; then
		MENU_LABELS+=("‚ûï Add New Bookmark")
		MENU_TYPES+=("action")
		MENU_INDEXES+=(-1)
		MENU_LABELS+=("‚úèÔ∏è Edit Bookmarks File")
		MENU_TYPES+=("action")
		MENU_INDEXES+=(-1)
	fi

	# Submenu-only action (at bottom)
	if [[ "$in_submenu" == "1" ]]; then
		MENU_LABELS+=("üîô Back")
		MENU_TYPES+=("action")
		MENU_INDEXES+=(-1)
	fi
}

open_search_dialog() {
	local entry_json="$1"
	local name
	local icon
	local search_url

	name=$(jq -r '.name // "Search"' <<<"$entry_json")
	icon=$(jq -r '.icon // "üîç"' <<<"$entry_json")
	search_url=$(jq -r '.search // empty' <<<"$entry_json")

	if [[ -z "$search_url" ]]; then
		# Fallback: if no explicit search URL, open href if present
		open_url "$(jq -r '.href // empty' <<<"$entry_json")"
		return
	fi

	local term
	term=$(dmenu_prompt "$icon $name" "" true)
	term=$(trim "$term")
	[[ -z "$term" ]] && return

	local encoded
	encoded=$(jq -nr --arg v "$term" '$v|@uri')

	local url
	if [[ "$search_url" == *"{}"* ]]; then
		url="${search_url//\{\}/$encoded}"
	else
		url="${search_url}${encoded}"
	fi

	open_url "$url"
}

main() {
	validate_bookmarks
	load_bookmarks_json || return 1

	local current_json="$BOOKMARKS_JSON"
	local current_path="~"
	local -a json_stack=()
	local -a path_stack=()

	while true; do
		local in_submenu=0
		((${#json_stack[@]} > 0)) && in_submenu=1

		build_menu_from_json "$current_json" "$in_submenu"

		local selection
		selection=$(printf '%s\n' "${MENU_LABELS[@]}" | dmenu_list "ÔÇ¨ $current_path" prefix true)
		[[ -z "$selection" ]] && exit 0

		case "$selection" in
		"üÜï New Tab")
			open_url "$STARTPAGE_URL"
			;;
		"üîô Back")
			if ((${#json_stack[@]} > 0)); then
				current_json="${json_stack[-1]}"
				unset 'json_stack[-1]'
				current_path="${path_stack[-1]}"
				unset 'path_stack[-1]'
			fi
			;;
		"‚ûï Add New Bookmark")
			add_bookmark
			load_bookmarks_json || return 1
			current_json="$BOOKMARKS_JSON"
			current_path="~"
			json_stack=()
			path_stack=()
			;;
		"‚úèÔ∏è Edit Bookmarks File")
			edit_bookmarks_file
			;;
		*)
			local found=0
			local idx=-1
			for i in "${!MENU_LABELS[@]}"; do
				if [[ "${MENU_LABELS[$i]}" == "$selection" && "${MENU_TYPES[$i]}" == "entry" ]]; then
					idx="${MENU_INDEXES[$i]}"
					found=1
					break
				fi
			done

			if [[ "$found" != "1" || "$idx" == "-1" ]]; then
				# Treat input as a custom URL
				open_url "$selection"
				continue
			fi

			local entry_json
			entry_json=$(jq -c --argjson i "$idx" '.[$i]' <<<"$current_json")
			if [[ -z "$entry_json" || "$entry_json" == "null" ]]; then
				continue
			fi

			# Match startpage behavior: content > dialog/search > href
			if jq -e '.content? | type == "array" and length > 0' <<<"$entry_json" >/dev/null 2>&1; then
				json_stack+=("$current_json")
				path_stack+=("$current_path")
				current_json=$(jq -c '.content' <<<"$entry_json")
				current_path+="/$(jq -r '.name // ""' <<<"$entry_json")"
			elif jq -e '(.dialog? == true) or (.search? != null)' <<<"$entry_json" >/dev/null 2>&1; then
				open_search_dialog "$entry_json"
			else
				open_url "$(jq -r '.href // empty' <<<"$entry_json")"
			fi
			;;
		esac
	done
}

# Open URL with default browser
open_url() {
	local url="$1"

	if [ -n "$url" ]; then
		# Add protocol if missing
		if [[ ! "$url" =~ ^(http|https|ftp):// ]]; then
			url="https://$url"
		fi

		# Launch and exit so rofi doesn't pop back up
		xdg-open "$url" >/dev/null 2>&1 &
		exit 0
	fi
}

# Add a new bookmark
add_bookmark() {
	# Get bookmark name
	name=$(dmenu_prompt "üìù Bookmark Name")
	if [[ -z "$name" ]]; then
		return
	fi

	# Get URL
	local url
	url=$(dmenu_prompt "üåê URL")
	if [[ -z "$url" ]]; then
		return
	fi

	if ! command -v jq >/dev/null 2>&1; then
		notify-send "dmenu-url" "jq is required to write JSON bookmarks" -t 2500
		return
	fi

	local tmp
	tmp=$(mktemp)
	jq --arg name "$(trim "$name")" --arg href "$(trim "$url")" \
		'. + [{name:$name, href:$href}]' \
		"$BOOKMARKS_FILE" >"$tmp" && mv "$tmp" "$BOOKMARKS_FILE"
	notify-send "Bookmark Added" "$name added to bookmarks" -t 2000
}

# Edit bookmarks file
edit_bookmarks_file() {
	"$EDITOR" "$BOOKMARKS_FILE"
}

# Run main function
main
