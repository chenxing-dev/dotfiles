#!/usr/bin/env bash
# System control menu with confirmation

backend="auto"
while [[ $# -gt 0 ]]; do
	case "$1" in
	--backend)
		backend="${2:-}"
		shift 2
		;;
	-h | --help)
		echo "Usage: dmenu-system [--backend rofi|fuzzel]" >&2
		exit 0
		;;
	*)
		echo "Unknown arg: $1" >&2
		exit 2
		;;
	esac
done

script_dir="$(CDPATH= cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
source "$script_dir/dmenu-backend.sh"
use_dmenu_backend "$backend"

options=(
	" Shutdown"
	" Reboot"
	"󰖳 Boot Windows"
	"󰗼 Quit session"
)

selected=$(printf '%s\n' "${options[@]}" | dmenu_list "System")

confirm() {
	echo -e "Yes\nNo" | dmenu_list "Confirm $1?" normal
}

quit_session() {
	# Prefer session-manager termination (DE/compositor agnostic).
	if command -v loginctl >/dev/null 2>&1; then
		if [[ -n "${USER:-}" ]]; then
			loginctl terminate-user "$USER" && return 0
		fi
		if [[ -n "${XDG_SESSION_ID:-}" ]]; then
			loginctl terminate-session "$XDG_SESSION_ID" && return 0
		fi
	fi

	# Fallback: ask systemd user manager to exit (may or may not end the graphical session).
	if command -v systemctl >/dev/null 2>&1; then
		systemctl --user exit && return 0
	fi

	echo "No supported session quit command found" >&2
	return 127
}

reboot_windows() {
	# Generic UEFI path: set BootNext to Windows Boot Manager, then reboot.
	if command -v efibootmgr >/dev/null 2>&1; then
		local bootnum
		bootnum=$(efibootmgr 2>/dev/null | sed -n 's/^Boot\([0-9A-Fa-f]\{4\}\)\*.*Windows Boot Manager.*/\1/p' | head -n1)
		if [[ -n "$bootnum" ]]; then
			if ! sudo -n -v >/dev/null 2>&1; then
				local sudo_password
				sudo_password=$(dmenu_password "[sudo] password for $USER: ") || return 1
				[[ -z "$sudo_password" ]] && return 1
				if ! printf '%s\n' "$sudo_password" | sudo -S -p '' -v >/dev/null 2>&1; then
					unset sudo_password
					if command -v notify-send >/dev/null 2>&1; then
						notify-send "Could not schedule reboot into Windows" "Sudo authentication failed"
					fi
					return 1
				fi
				unset sudo_password
			fi

			if sudo efibootmgr -n "$bootnum"; then
				sudo systemctl reboot && return 0
				systemctl reboot && return 0
				return 1
			fi
		fi
		notify-send "Failed to set BootNext to Windows Boot Manager (permission denied or firmware rejected)" >&2
	fi

	if command -v notify-send >/dev/null 2>&1; then
		notify-send "Could not schedule reboot into Windows" "Need root privileges and UEFI Windows Boot Manager"
	fi
	echo "Could not schedule reboot into Windows" >&2
	return 1
}

case $selected in
" Shutdown")
	[[ $(confirm "Shutdown") == "Yes" ]] && systemctl poweroff
	;;
" Reboot")
	[[ $(confirm "Reboot") == "Yes" ]] && systemctl reboot
	;;
"󰖳 Boot Windows")
	[[ $(confirm "Boot Windows") == "Yes" ]] && reboot_windows
	;;
"󰗼 Quit session")
	[[ $(confirm "Quit session") == "Yes" ]] && quit_session
	;;
esac
